name: Docker

on:
  push:
    # Publish `main` as Docker `latest` image.
    branches:
      - main
      - api-rewrite

jobs:
  # Push image to GitHub Packages.
  # See also https://docs.docker.com/docker-hub/builds/
  push:
    # Ensure test job passes before pushing image.
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
        - uses: actions/checkout@v4

        - name: Copy secret files
          run: mv config.json.template config.json; mv api/Rocket.toml.template api/Rocket.toml

        - name: Log into registry
          run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

        - name: Build image
          run: docker compose build
        
        - name: Push image to Container Registry
          run: docker compose -f docker-compose.yaml